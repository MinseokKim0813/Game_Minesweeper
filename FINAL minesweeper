#include <iostream>
#include <cstdlib>
#include <ctime>

using namespace std;

class Minesweeper
{
private:
    int **grid;             // 2D array to store the grid of the minesweeper game
    bool **revealed;        // 2D array to track which cells are revealed
    bool **flagged;         // 2D array to track which cells are flagged as mines
    int width, height, mines;   // Width, height, and number of mines in the grid
    int remainingSafeSquares;   // Number of unrevealed non-mine squares

    // Count the number of mines adjacent to a given cell
    int countMines(int x, int y)
    {
        int count = 0;
        for (int dx = -1; dx <= 1; dx++) // Check coordinates that make a square around it
        {
            for (int dy = -1; dy <= 1; dy++)
            {
                if (dx == 0 && dy == 0)
                    continue;
                int nx = x + dx, ny = y + dy;
                if (isValid(nx, ny) && grid[nx][ny] == -1) // out of bounds condition --> isValid
                {
                    count++; // count increases if there's a mine around it
                }
            }
        }
        return count;
    }

    // Randomly place mines on the grid
    void placeMines()
    {
        srand((unsigned)time(NULL)); // Seed the random number generator
        for (int i = 0; i < mines; i++)
        {
            int x, y;
            do
            {
                x = rand() % height;
                y = rand() % width;
            } while (grid[x][y] == -1); // loop if (x,y) is already a mine
            grid[x][y] = -1; // assign (x,y) as mine
        }

        // Calculate the number of mines adjacent to each cell
        for (int x = 0; x < height; x++)
        {
            for (int y = 0; y < width; y++)
            {
                if (grid[x][y] != -1)
                {
                    grid[x][y] = countMines(x, y); // Call countMines to assign value to coordinates that are not a mine
                    remainingSafeSquares++; // Count each non-mine square
                }
            }
        }
    }

public:
    
    // Check if a given position is within the bounds of the grid
    bool isValid(int x, int y)
    {
        return (x >= 0 && x < height && y >= 0 && y < width);
    }
    
    // Constructor to initialize the game with given dimensions and number of mines
    Minesweeper(int w, int h, int m) : width(w), height(h), mines(m), remainingSafeSquares(0)
    {
        grid = new int *[height];
        revealed = new bool *[height];
        flagged = new bool *[height];
        for (int i = 0; i < height; i++)
        {
            grid[i] = new int[width];
            revealed[i] = new bool[width];
            flagged[i] = new bool[width];
            for (int j = 0; j < width; j++)
            {
                grid[i][j] = 0;
                revealed[i][j] = false;
                flagged[i][j] = false;
            }
        }
        placeMines();
    }

    // Destructor to free memory allocated for grid
    ~Minesweeper()
    {
        for (int i = 0; i < height; i++)
        {
            delete[] grid[i];
            delete[] revealed[i];
            delete[] flagged[i];
        }
        delete[] grid;
        delete[] revealed;
        delete[] flagged;
    }

    // Display the current state of the game grid
    void display()
    {
        cout << "\nRemaining Safe Squares: " << remainingSafeSquares << endl << endl;

        // Print the top column labels
        cout << "    ";
        for (int y = 0; y < width; y++)
        {
            if (y < 10)
            {
                cout << " " << y << "  ";
            }
            else
            {
                cout << y << "  ";
            }
        }
        cout << endl;

        // Print the top border
        cout << "   +";
        for (int y = 0; y < width; y++)
        {
            cout << "---+";
        }
        cout << endl;

        // Print the grid
        for (int x = 0; x < height; x++)
        {
            if (x < 10)
            {
                cout << " " << x << " |";
            }
            else
            {
                cout << x << " |";
            }

            for (int y = 0; y < width; y++)
            {
                if (revealed[x][y])
                {
                    if (grid[x][y] == -1)
                    {
                        cout << " * |"; // Mine
                    }
                    else
                    {
                        cout << " " << grid[x][y] << " |"; // Number of mines around
                    }
                }
                else if (flagged[x][y])
                {
                    cout << " F |"; // Flagged
                }
                else
                {
                    cout << "   |"; // Unrevealed
                }
            }
            cout << endl;

            // Print border after each row
            cout << "   +";
            for (int y = 0; y < width; y++)
            {
                cout << "---+";
            }
            cout << endl;
        }
    }

    // Open a cell in the grid, return true if the game is still ongoing, false if a mine is hit
    bool openCell(int x, int y)
    {
        if (!isValid(x, y) || revealed[x][y] || flagged[x][y])
            return true;
        revealed[x][y] = true;
        if (grid[x][y] == -1)
            return false;       // Mine hit
        remainingSafeSquares--; // Decrement count of unrevealed safe squares
        if (grid[x][y] == 0)
        {
            for (int dx = -1; dx <= 1; dx++)
            {
                for (int dy = -1; dy <= 1; dy++)
                {
                    int nx = x + dx, ny = y + dy;
                    if (isValid(nx, ny) && !revealed[nx][ny])
                        openCell(nx, ny);
                }
            }
        }
        return true;
    }

    // Toggle flag on a cell
    void toggleFlag(int x, int y)
    {
        if (!revealed[x][y])
            flagged[x][y] = !flagged[x][y];
    }

    // Check if the game is won
    bool checkWin()
    {
        if (remainingSafeSquares == 0)
            return true;
        return false;
    }
};

// Main function to run the Minesweeper game
int main()
{
    srand((unsigned)time(NULL)); // Seed the random number generator

    while (true)
    {
        // Main menu
        cout << "Main Menu\n\n";
        cout << "1. Play\n";
        cout << "2. Help\n";
        cout << "3. Exit\n";
        cout << "\nEnter your choice: ";
        int choice;
        cin >> choice;

        switch (choice)
        {
        case 1: // Play the game
        {
            cout <<"\nWelcome to Minesweeper Mania!!!\n";
            cout << "\nSelect Difficulty:\n";
            cout << "1) Easy (grid size: 6x6, No. of mines = 6)\n";
            cout << "2) Medium (grid size: 12x12, No. of mines = 24)\n";
            cout << "3) Hard (grid size: 25x25, No. of mines = 104)\n";
            cout << "4) Custom\n";
            cout << "\nEnter your choice: ";
            cin >> choice;
            while (choice < 1 || choice > 4)
                {
                    cout << "Invalid choice. Please select again: ";
                    cin >> choice;
                }
            int width, height, mines;
            switch (choice)
            {
            case 1:
                width = height = 6;
                mines = 6;
                break;
            case 2:
                width = height = 12;
                mines = 24;
                break;
            case 3:
                width = height = 25;
                mines = 104;
                break;
            case 4:
                cout << "Enter custom grid size (6~25): ";
                cin >> width;
                while (width < 6 || width > 25)
                    {
                        cout << "Invalid choice. Please select again: ";
                        cin >> width;
                    }
                height = width;
                mines = (width * height) / 6;
                break;
            default:
                continue;
            }
            Minesweeper game(width, height, mines);
            bool gameOver = false;
            while (!gameOver)
            {
                game.display();
                cout << "\nChoose an action:\n1. Open a cell\n2. Flag/Unflag a cell\n3. Exit to main menu\n";
                cin >> choice;
                while (choice < 1 || choice > 3)
                    {
                        cout << "Invalid choice. Please select again: ";
                        cin >> choice;
                    }
                switch (choice)
                {
                case 1:
                    cout << "Enter row and column numbers: ";
                    int x, y;
                    cin >> x >> y;
                    while (!game.isValid(x,y))
                        {
                            cout << "Invalid choice. Please select again: ";
                            cin >> x >> y;
                        }
                    if (!game.openCell(x, y))
                        {
                            cout << "\nGame Over! You hit a mine!\n";
                            game.display();
                            gameOver = true;
                        }
                    if (game.checkWin())
                    {
                        cout << "Congratulations! You cleared the minefield!\n";
                        game.display();
                        gameOver = true;
                    }
                    break;
                case 2:
                    cout << "Enter row and column numbers to flag/unflag: ";
                    cin >> x >> y;
                    while (!game.isValid(x,y))
                        {
                            cout << "Invalid choice. Please select again: ";
                            cin >> x >> y;
                        }
                    game.toggleFlag(x, y);
                    break;
                case 3:
                    gameOver = true;
                    break;
                }
            }
            break;
        }
        case 2: // Help menu with comprehensive instructions
        {
            cout << endl;
            cout << "Welcome to Minesweeper Mania!!!\nMinesweeper is a classic single-player puzzle game where the objective is to clear a rectangular grid containing hidden mines without detonating any of them.\n\n";
            cout << "How to Use the Program:\n";
            cout << "1. Upon starting the program, you'll be presented with a main menu offering several options.\n";
            cout << "2. Choose 'Play' to start a new game, 'Help' to view instructions, or 'Exit' to leave the game.\n";
            cout << "3. If you choose 'Play', you'll be prompted to select a difficulty level: Easy, Medium, Hard, or Custom.\n";
            cout << "4. In Custom mode, you can specify the grid size and number of mines.\n";
            cout << "5. During the game, you'll be able to open cells, flag or unflag cells as mines, or return to the main menu.\n\n";
            cout << "How to Play the Game:\n";
            cout << "1. The game grid consists of cells, some of which contain mines.\n";
            cout << "2. Your goal is to uncover all cells that do not contain mines.\n";
            cout << "3. To uncover a cell, select 'Open a cell' and enter the row and column numbers of the cell you want to reveal.\n";
            cout << "4. If the cell you open contains a mine, you lose the game.\n";
            cout << "5. If the cell does not contain a mine, it will display a number indicating how many mines are adjacent to it.\n";
            cout << "6. Use the numbers to strategically uncover safe cells.\n";
            cout << "7. You can flag cells that you suspect contain mines to prevent accidentally opening them.\n";
            cout << "8. To flag or unflag a cell, choose 'Flag/Unflag a cell' and enter the row and column numbers.\n";
            cout << "9. Continue uncovering cells and flagging mines until all non-mine cells are revealed.\n";
            cout << "10. If you successfully uncover all safe cells without hitting any mines, you win the game!\n\n";
            cout << "Remember:\n";
            cout << "- Be cautious when opening cells, as hitting a mine ends the game.\n";
            cout << "- Use logic and deduction to determine the locations of mines.\n";
            cout << "- Pay attention to the numbers displayed in uncovered cells to help identify safe moves.\n\n";
            break;
        }
        case 3: // Exit
            cout << "Exiting game.\n";
            return 0;
        default:
            cout << "Invalid choice. Please enter 1, 2, or 3.\n";
        }
    }

    return 0;
}
