#include <iostream>
#include <cstdlib>
#include <ctime>

using namespace std;

class Minesweeper
{
private:
    int **grid;
    bool **revealed;
    bool **flagged;
    int width, height, mines;
    int remainingSafeSquares; // Variable to track remaining non-mine squares

    // randomly place mines on the grid
    // randomly generate x and y coordinates
    // then check if the land already has mine or not
    // if it has mine, randomly generate coordinates again
    // if it doesn't have mine, place it there
    void placeMines()
    {
        srand((unsigned)time(NULL)); // random number generator

        // for each mine
        for (int i = 0; i < mines; i++)
        {
            int x, y;
            do
            {
                // random number coordinates
                x = rand() % height;
                y = rand() % width;
            } while (grid[x][y] == -1); // repeat until placing at unmined cell
            grid[x][y] = -1;
        }

        // for each land
        for (int x = 0; x < width; x++)
        {
            for (int y = 0; y < height; y++)
            {
                // if the land doesn't have mine
                if (grid[x][y] != -1)
                {
                    // assign the number for the land
                    // which is the number of adjacent mines from the selected land
                    grid[x][y] = countMines(x, y);

                    // keep a track of the number of non-mine square
                    remainingSafeSquares++;
                }
            }
        }
    }

    // count number of mines adjacent to the selected land
    int countMines(int x, int y)
    {
        int count = 0;

        // for adjacent land x-coordinates
        for (int dx = -1; dx <= 1; dx++)
        {
            // for adjacent land y-coordinates
            for (int dy = -1; dy <= 1; dy++)
            {
                // skip the selected land coordinate itself
                if (dx == 0 && dy == 0)
                {
                    continue;
                }

                // adjacent land x and y coordinates
                int adjLandX = x + dx, adjLandY = y + dy;

                // if it is within the grid and has mine
                if (isValid(adjLandX, adjLandY) && grid[adjLandX][adjLandY] == -1)
                {
                    // no. of adjacent mines++
                    count++;
                }
            }
        }

        return count;
    }

public:
    // check if the selected land is withing the grid
    bool isValid(int x, int y)
    {
        if (x >= 0 && x < width && y >= 0 && y < height)
        {
            return true;
        }

        return false;
    }
    
    // Constructor to initialize the game with given dimensions and number of mines
    Minesweeper(int w, int h, int m)
    {
        width = w;
        height = h;
        mines = m;
        remainingSafeSquares = 0;

        grid = new int *[height];
        revealed = new bool *[height];
        flagged = new bool *[height];
        for (int i = 0; i < height; i++)
        {
            grid[i] = new int[width];
            revealed[i] = new bool[width];
            flagged[i] = new bool[width];
            for (int j = 0; j < width; j++)
            {
                grid[i][j] = 0;
                revealed[i][j] = false;
                flagged[i][j] = false;
            }
        }
        placeMines();
    }

    ~Minesweeper()
    {
        for (int i = 0; i < height; i++)
        {
            delete[] grid[i];
            delete[] revealed[i];
            delete[] flagged[i];
        }
        delete[] grid;
        delete[] revealed;
        delete[] flagged;
    }

    void display()
    {
        cout << "\nRemaining Safe Squares: " << remainingSafeSquares << endl;

        // Print the top column labels
        cout << "    "; // Add extra space before column numbers for alignment
        for (int y = 0; y < width; y++)
        {
            if (y < 10)
            {
                cout << " " << y << "  "; // Extra space for single digit columns
            }
            else
            {
                cout << y << "  "; // Normal spacing for double digits
            }
        }
        cout << endl;

        // Print the top border
        cout << "   +"; // Align the start of the grid
        for (int y = 0; y < width; y++)
        {
            cout << "---+";
        }
        cout << endl;

        for (int x = 0; x < height; x++)
        {
            // Handle single and double-digit row numbers
            if (x < 10)
            {
                cout << " " << x << " |"; // Extra space for single digit rows
            }
            else
            {
                cout << x << " |"; // Normal for double digits
            }

            for (int y = 0; y < width; y++)
            {
                if (revealed[x][y])
                {
                    if (grid[x][y] == -1)
                    {
                        cout << " * |"; // Mine
                    }
                    else
                    {
                        cout << " " << grid[x][y] << " |"; // Number of mines around
                    }
                }
                else if (flagged[x][y])
                {
                    cout << " F |"; // Flagged
                }
                else
                {
                    cout << "   |"; // Unrevealed
                }
            }
            cout << endl;

            // Print border after each row
            cout << "   +"; // Align the start of the row border
            for (int y = 0; y < width; y++)
            {
                cout << "---+";
            }
            cout << endl;
        }
    }

    bool openCell(int x, int y)
    {
        if (!isValid(x, y) || revealed[x][y] || flagged[x][y])
            return true;
        revealed[x][y] = true;
        if (grid[x][y] == -1)
            return false;       // Mine hit
        remainingSafeSquares--; // Decrement count of unrevealed safe squares
        if (grid[x][y] == 0)
        {
            for (int dx = -1; dx <= 1; dx++)
            {
                for (int dy = -1; dy <= 1; dy++)
                {
                    int nx = x + dx, ny = y + dy;
                    if (isValid(nx, ny) && !revealed[nx][ny])
                        openCell(nx, ny);
                }
            }
        }
        return true;
    }

    void toggleFlag(int x, int y)
    {
        if (!revealed[x][y])
            flagged[x][y] = !flagged[x][y];
    }

    // Check if the player has won the game
    bool checkWin()
    {
        if (remainingSafeSquares == 0)
            return true;
        return false;
    }
};

// Main function to run the Minesweeper game
int main()
{
    srand((unsigned)time(NULL)); // Seed the random number generator

    while (true)
    {
        cout << "Main Menu\n\n";
        cout << "1. Play\n";
        cout << "2. Help\n";
        cout << "3. Exit\n";
        cout << "\nEnter your choice: ";
        int choice;
        cin >> choice;

        switch (choice)
        {
        case 1: //Play the game
        {
            cout <<"\nWelcome to Minesweeper Mania!!!\n";
            cout << "\nSelect Difficulty:\n";
            cout << "1) Easy (grid size: 6x6, No. of mines = 6)\n";
            cout << "2) Medium (grid size: 12x12, No. of mines = 24)\n";
            cout << "3) Hard (grid size: 25x25, No. of mines = 104)\n";
            cout << "4) Custom\n";
            cout << "\nEnter your choice: ";
            cin >> choice;
            while (choice < 1 || choice > 4)
            {
                cout << "Invalid choice. Please select again: ";
                cin >> choice;
            }
            int width, height, mines;
            switch (choice)
            {
            case 1:
                width = height = 6;
                mines = 6;
                break;
            case 2:
                width = height = 12;
                mines = 24;
                break;
            case 3:
                width = height = 25;
                mines = 104;
                break;
            case 4:
                cout << " Please enter the row/column (6~25): " << endl;
                cin >> width;
                while (width < 6 || width > 25)
                {
                    cout << "Invalid choice. Please select again: ";
                    cin >> width;
                }
                height = width;
                mines = (width * height) / 6;
                break;
            default:
                continue;
            }
            Minesweeper game(width, height, mines);
            bool gameOver = false;
            while (!gameOver)
            {
                game.display();
                cout << "\nChoose an action:\n1. Open a cell\n2. Flag/Unflag a cell\n3. Exit to main menu\n";
                cin >> choice;
                while (choice < 1 || choice > 3)
                {
                    cout << "Invalid choice. Please select again: ";
                    cin >> choice;
                }
                switch (choice)
                {
                case 1:
                    cout << "Enter row and column number to select the square: ";
                    int x, y;
                    cin >> x >> y;
                    while (!game.isValid(x,y))
                        {
                            cout << "Invalid choice. Please select again: ";
                            cin >> x >> y;
                        }
                    if (!game.openCell(x, y))
                    {
                        cout << "\nGame Over! You hit a mine!\n";
                        game.display();
                        gameOver = true;
                    }
                    if (game.checkWin())
                    {
                        cout << "\nCongratulations! You cleared the minefield!\n";
                        gameOver = true;
                    }
                    break;
                case 2:
                    cout << "Enter row and column numbers to flag/unflag: ";
                    cin >> x >> y;
                    while (!game.isValid(x,y))
                        {
                            cout << "Invalid choice. Please select again: ";
                            cin >> x >> y;
                        }
                    game.toggleFlag(x, y);
                    break;
                case 3:
                    gameOver = true;
                    break;
                }
            }
            break;
        }
        case 2: // Help menu with comprehensive instructions
        {
            cout << endl;
            cout << "Welcome to Minesweeper Mania!!!\nMinesweeper is a classic single-player puzzle game where the objective is to clear a rectangular grid containing hidden mines without detonating any of them.\n\n";
            cout << "How to Use the Program:\n";
            cout << "1. Upon starting the program, you'll be presented with a main menu offering several options.\n";
            cout << "2. Choose 'Play' to start a new game, 'Help' to view instructions, or 'Exit' to leave the game.\n";
            cout << "3. If you choose 'Play', you'll be prompted to select a difficulty level: Easy, Medium, Hard, or Custom.\n";
            cout << "4. In Custom mode, you can specify the grid size and number of mines.\n";
            cout << "5. During the game, you'll be able to open cells, flag or unflag cells as mines, or return to the main menu.\n\n";
            cout << "How to Play the Game:\n";
            cout << "1. The game grid consists of cells, some of which contain mines.\n";
            cout << "2. Your goal is to uncover all cells that do not contain mines.\n";
            cout << "3. To uncover a cell, select 'Open a cell' and enter the row and column numbers of the cell you want to reveal.\n";
            cout << "4. If the cell you open contains a mine, you lose the game.\n";
            cout << "5. If the cell does not contain a mine, it will display a number indicating how many mines are adjacent to it.\n";
            cout << "6. Use the numbers to strategically uncover safe cells.\n";
            cout << "7. You can flag cells that you suspect contain mines to prevent accidentally opening them.\n";
            cout << "8. To flag or unflag a cell, choose 'Flag/Unflag a cell' and enter the row and column numbers.\n";
            cout << "9. Continue uncovering cells and flagging mines until all non-mine cells are revealed.\n";
            cout << "10. If you successfully uncover all safe cells without hitting any mines, you win the game!\n\n";
            cout << "Remember:\n";
            cout << "- Be cautious when opening cells, as hitting a mine ends the game.\n";
            cout << "- Use logic and deduction to determine the locations of mines.\n";
            cout << "- Pay attention to the numbers displayed in uncovered cells to help identify safe moves.\n\n";
            break;
        }
        case 3:
            cout << "Exiting game.\n";
            return 0;
        default:
            cout << "Invalid choice. Please enter 1, 2, or 3.\n";
        }
    }

    return 0;
}
